<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SMARTTR">
<title>1. Imaging, segmentation, and preprocessing • SMARTTR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="1. Imaging, segmentation, and preprocessing">
<meta property="og:description" content="SMARTTR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SMARTTR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/SMARTTR.html">Get started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Part1.Segmentation.html">1. Imaging, segmentation, and preprocessing</a>
    <a class="dropdown-item" href="../articles/Part2.Tutorial.html">2. Mapping Tutorial</a>
    <a class="dropdown-item" href="../articles/Part3.Scripting.html">3. Scripting &amp; notebooks</a>
    <a class="dropdown-item" href="../articles/Part4.Example_Analysis_Notebook.html">4. Example analysis notebook</a>
    <a class="dropdown-item" href="../articles/Part5.ImportingExternalDatasets.html">5. Importing External Datasets</a>
    <a class="dropdown-item" href="../articles/Part6.FAQ.html">6. FAQ</a>
    <a class="dropdown-item" href="../articles/Part7.Development.html">7. Development environment</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mjin1812/SMARTTR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>1. Imaging, segmentation, and preprocessing</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mjin1812/SMARTTR/blob/HEAD/vignettes/Part1.Segmentation.Rmd" class="external-link"><code>vignettes/Part1.Segmentation.Rmd</code></a></small>
      <div class="d-none name"><code>Part1.Segmentation.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="imaging-pre-processing-segmentation">Imaging, pre-processing &amp; segmentation<a class="anchor" aria-label="anchor" href="#imaging-pre-processing-segmentation"></a>
</h2>
<figure><img src="../reference/figures/3.acquisition_segmentation_preprocess_schematic.jpg" alt="Image" style="width: 650px; height: 400px;"><figcaption><em>Imaging, segmentation, and pre-processing pipeline</em>
</figcaption></figure><div class="section level3">
<h3 id="imaging-parameters">Imaging parameters<a class="anchor" aria-label="anchor" href="#imaging-parameters"></a>
</h3>
<p>Our example images were taken on a confocal scanning microscope
(Leica TCS SP8, Leica Microsystems Inc. Wetzlar, Germany) with two PMT
detectors using a dry 20x objective (NA 0.60, working distance 0.5 mm).
We use the following imaging parameters:</p>
<ul>
<li>Pixel size of 1.08 x 1.08um<sup>2</sup>
</li>
<li>z-step size of 3 um</li>
<li>z-stack size of 9 um.</li>
</ul>
<p>The first channel of our images (C1) captures YFP staining, while the
second channel of our images (C2) captures cfos staining.
Immunolabelling details are documented in our companion paper (To Link).
Fields of view are stitched together to form tiled images by using an
automated stage and the tiling function and algorithm of the LAS X
software. An example image taken using these settings without any
previous pre-processing steps is <a href="https://osf.io/mvjch" class="external-link">downloadable</a>.</p>
<p>Although this pipeline is designed to be generalizable to other
images with different parameters we recommend organizing and saving
channel order in a similar format to ours.</p>
</div>
<div class="section level3">
<h3 id="file-organization">File organization<a class="anchor" aria-label="anchor" href="#file-organization"></a>
</h3>
<p>Each image file is stored in a hierarchical folder structure in a
slice folder then a mouse folder:</p>
<p><code>Root folder &gt; project folder &gt; ... &gt; mouse no. &gt; slice name &gt; image file</code></p>
<p>The image files, which we also refer to as slices, are assumed to
follow the naming convention <code>mouseNo_slice.ext</code>.</p>
<p>The <code>slice</code> is a unique tag or index used to identify the
particular section when it was imaged on a slice. For example, we use an
indexing system where the first number identifies the slide number and a
second number identifies position on that slide. These numbers are
separated by an underscore. Therefore the slice <code>1_1</code>
represents section one of slide one for this animal. Of course, other
indexing approaches can be used. We create a slice name by concatenating
the slice with the mouse ID separate by an underscore to name images
unambiguously.</p>
<p>For example, here is one of our image directory paths:</p>
<p><code>V:/Learned_Helplessness/Mapping_Images/Shock/733/733_1_1</code></p>
<p>And this is the file path to the image stored in that directory:</p>
<p><code>V:/Learned_Helplessness/Mapping_Images/Shock/733/733_1_1/733_1_1.lif</code></p>
<p>Here, the image or slice name is <code>733_1_1.lif</code> with the
slice no. being <code>1_1</code>. This section came from mouse 733. This
heirarchical file structure is helpful, as all segmentation files and
preprocessing files will be stored in each image folder while all mouse
object files will be stored in the parent mouse directory.</p>
</div>
<div class="section level3">
<h3 id="fijiimagej-software-setup">FIJI/ImageJ Software Setup<a class="anchor" aria-label="anchor" href="#fijiimagej-software-setup"></a>
</h3>
<p>To use the segmentation macros we have on this example dataset, <a href="https://imagej.net/software/fiji/downloads" class="external-link">Fiji/ImageJ</a> needs
to be installed as well as the <a href="https://imagej.net/formats/bio-formats" class="external-link">Bio-Formats Importer</a>,
<a href="https://mcib3d.frama.io/3d-suite-imagej/#installation" class="external-link">3D
ImageJ suite</a>, and <a href="https://imagej.net/plugins/morpholibj#installation" class="external-link">MorphoLibJ</a>
plugins. Follow the steps in each webpage to install the plugins either
using the manage update site option in ImageJ or manually. We have
validated our pipeline using ImageJ version 2.9.0 (64-bit).</p>
<p>The Bio-Formats Importer is just a plugin that helps import a variety
of common imaging formats into ImageJ. 3D ImageJ Suite provides a suite
of plugins to enhance 3D image processing capabilities. Our segmentation
and colocalization macros are dependent on the 3D ImageJ Suite plugin
and we have validated our segmentation scripts on the latest version of
the plugin (v4.1.5).</p>
</div>
<div class="section level3">
<h3 id="convert-to-tiff">Convert to TIFF<a class="anchor" aria-label="anchor" href="#convert-to-tiff"></a>
</h3>
<p>For full transparency of our pre-processing steps, our example raw
image provided is in the format exported immediately after image
acquisition. The image file format is a .lif file, which is a
proprietary format associated with Leica microscopes.</p>
<p>To make our segmentation approach more generalizable, we convert our
image to .tif files before proceeding with the rest of preprocessing. We
can do this automatically using an Image <a href="https://osf.io/uarnt" class="external-link">macro</a> that iterates through all .lif
files in a root folder. Drag the macro file into the ImageJ window and
once the macro window pops up, click “Run”. You should see the following
pop up window.</p>
<figure><img src="../reference/figures/batch_create_tiff.JPG" alt="Image" style="width: 400px;"><figcaption><em>batch_create_tiff.ijm pop up window </em>
</figcaption></figure><p>Hit “OK”, then navigate to a root folder and hit “Select”. ImageJ
will then convert all images in subdirectories of the root folder
matching the .lif extension.</p>
<p>For those who are not using Leica microscopes, starting with a .tif
file will serve as a general entry point into the pipeline. If this is
the entry point, an empty file should be created in each image folder
saved as the image name with an extension other than .tif,
e.g. 733_1_4.lif. This will be used as a dummy file to hunt for the
proper image name in downstream pre-processing and segmentation steps.
.tif cannot be used because a number of .tif files are optionally
created as outputs from segmentation.</p>
<figure><img src="../reference/figures/Save_dummy_lif.JPG" alt="Image" style="width: 400px;"><figcaption><em>Save an empty file with the same image name and a unique extension
</em>
</figcaption></figure>
</div>
<div class="section level3">
<h3 id="flatten-the-tiff-images-for-registration">Flatten the TIFF images for registration<a class="anchor" aria-label="anchor" href="#flatten-the-tiff-images-for-registration"></a>
</h3>
<p>Although cell counts may be segmented in 3D, during the registration
process, a single coronal atlas plate from the Allen Mouse Brain Atlas
is fitted to a 2D <code>.tif</code> image. Therefore, if you are
processing any z-stack images, they need to be flattened and channels
need to be collapsed into a single image used for the purpose of
registration. For our images, we have an <a href="https://osf.io/2thw8" class="external-link">ImageJ macro</a> that does this on our .tif
images automatically by creating a maximum projection image.</p>
<p>The followup window should popup when you run this macro. The default
parameters should be fine, but you can change the contrast saturation
parameter to optimize the image saturation levels. Please note that the
.lif extension is still used <em>only</em> to detected the original
image name.</p>
<figure><img src="../reference/figures/batch_create_max_projection.JPG" alt="Image" style="width: 400px;"><figcaption><em>batch_create_max_projection pop up window </em>
</figcaption></figure><p>The default parameters should be fine, but you can change the
contrast saturation parameter to optimize the image saturation levels.
The transformed images are then autosaved into each image directory as
<code>MAX_SliceName.tif</code>. The path to this file will be used as
the registration path. Note that once this file is made, any part of the
pipeline using SMARTTR related to image registration can proceed
independently of image segmentation.</p>
</div>
<div class="section level3">
<h3 id="c-fos-segmentation-using-a-generalized-3d-segmentation-macro">c-Fos segmentation using a generalized 3D segmentation macro<a class="anchor" aria-label="anchor" href="#c-fos-segmentation-using-a-generalized-3d-segmentation-macro"></a>
</h3>
<p>We have developed a generalized ImageJ <a href="https://osf.io/bek56" class="external-link">macro</a> that works well for segmenting
cells from images with staining patterns characteristic of c-Fos
immunolabelling. c-Fos staining is typically punctate and localizes to
the cell body, with each cell resembling a filled sphere. We recommend
using this macro twice if you are staining two channels with similar
immunolabelling patterns as c-Fos.</p>
<p>The macro segments c-Fos cells using the following steps.</p>
<ul>
<li>Images are <a href="https://imagej.net/ij/plugins/fft-filter.html" class="external-link">bandpass
filtered</a> in Fourier space</li>
<li>Image background is subtracted using a <a href="https://imagej.net/plugins/rolling-ball-background-subtraction" class="external-link">rolling
ball algorithm</a>
</li>
<li>Cells are identified using the 3D Local Maxima Faster Filter, <a href="https://imagej.net/plugins/3d-segmentation" class="external-link">3D Spot
Segmentation</a>
</li>
<li>Cells are quantified and saved using the 3D Manager plugin</li>
<li>The binary segmentation image is optionally saved as a .tif.</li>
</ul>
<figure><img src="../reference/figures/batch_3DSegmentation_Fast.JPG" alt="Image" style="width: 400px;"><figcaption><em>batch_3DSegmentation_Fast pop up window </em>
</figcaption></figure><p>Hit ‘Run’ to start the macro. The default parameters for these steps
are already optimized for our imaging parameters and work well on our
example image. The parameters are also user-modifiable to account for
different imaging parameters and different channel orders. Hit ‘OK’ to
accept the current parameters, then navigate to a root folder containing
all the nested subdirectories you want to process. If there are many
images to process, we recommend running this macro overnight, as it may
be computationally intensive. Once processing is finished, you will
notice two new .txt. files in each image folder starting with “M_” and
“Q_” that collectively store the quantified cell counts and each cell
object’s image properties. “Save segmentation binary?” needs to be
checked at this step if you are interested in running this channel
through a colocalization analysis downstream.</p>
</div>
<div class="section level3">
<h3 id="eyfp-segmentation">eYFP segmentation<a class="anchor" aria-label="anchor" href="#eyfp-segmentation"></a>
</h3>
<p>Due to the dendritic expression of eYFP, we use a separate
segmentation <a href="https://osf.io/tz2pe" class="external-link">macro</a> optimized to
segment eYFP+ cells with with more cellular processes branching from the
cell body. The segmentation steps are similar in principle to that used
for c-Fos staining:</p>
<ul>
<li>Background subtraction</li>
<li>Image blurring with a Gaussian kernel</li>
<li>Image thresholding for the brightest fraction of pixels
(e.g. threshold of 0.005 for the top 0.5% brightest pixels)</li>
<li>The brightest pixels are used as a mask to apply a 3D <a href="https://imagej.net/plugins/classic-watershed" class="external-link">watershed</a>
algorithim. This restricts the area of application of the
algorithm.</li>
</ul>
<p>The default parameters for this step are already optimized for our
imaging parameters.To run images through the colocalization analysis,
“Save segmentation .tif?” needs to be checked at this step.</p>
<figure><img src="../reference/figures/batch_EYFPSegmentation.JPG" alt="Image" style="width: 400px;"><figcaption><em>batch_EYFPSegmentation pop up window </em>
</figcaption></figure><p>Hit ‘Run’ and navigate to a root folder you want to process.
Similarly to the c-Fos segmentation using the generalized 3D
segmentation macro, new .txt files starting with “M_” and “Q_” will
store information about the quantified cell counts in each image
folder.</p>
</div>
<div class="section level3">
<h3 id="co-labelled-cell-identification">Co-labelled cell identification<a class="anchor" aria-label="anchor" href="#co-labelled-cell-identification"></a>
</h3>
<p>This step is optional for those interested in looking at colocalized
cell populations. We use the <a href="https://mcib3d.frama.io/3d-suite-imagej/plugins/Analysis/Relationships/3D-MultiColoc/" class="external-link">3D
MultiColoc</a> plugin in the ImageJ suite to identify co-localized
cells. This plugin will identify the percentage of volumetric overlap
between all objects in two different segmented images and return a table
of these comparisons. Download our <a href="https://osf.io/dgsj4" class="external-link">macro</a> which applies this plugin to all
the images in a root folder that have already been segmented for c-Fos
and eYFP.</p>
<p>Run the macro and you will see the following menu pop up:</p>
<figure><img src="../reference/figures/batch_coloc.JPG" alt="Image" style="width: 400px;"><figcaption><em>batch_Coloc_cfos_eyfp popup window </em>
</figcaption></figure><p>Replace the entry for “C1 segmentation file ext” with the exact stem
of the .tif storing the segmented objects for channel 1 (eYFP) without
the image name. In our images, this stem is “_C1_eYFP_LabelImage.tif”.
Then do the same thing for channel 2 for the c-Fos segmentation image.
This macro will save additional colocalization information as .txt files
in the image folder.</p>
<p>Once this step is done, you’re ready to import the segmentation and
colocalization information into the SMARTTR pipeline!</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michelle Jin.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
