<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SMARTTR">
<title>2. Mapping Tutorial • SMARTTR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Mapping Tutorial">
<meta property="og:description" content="SMARTTR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SMARTTR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/SMARTTR.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Part1.Segmentation.html">1. Imaging, segmentation, and preprocessing</a>
    <a class="dropdown-item" href="../articles/Part2.Tutorial.html">2. Mapping Tutorial</a>
    <a class="dropdown-item" href="../articles/Part3.Scripting.html">3. Scripting &amp; notebooks</a>
    <a class="dropdown-item" href="../articles/Part4.Example_Analysis_Notebook.html">4. Example analysis notebook</a>
    <a class="dropdown-item" href="../articles/Part5.ImportingExternalDatasets.html">5. Importing External Datasets</a>
    <a class="dropdown-item" href="../articles/Part6.FAQ.html">6. FAQ</a>
    <a class="dropdown-item" href="../articles/Part7.Development.html">7. Development environment</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mjin1812/SMARTTR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>2. Mapping Tutorial</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mjin1812/SMARTTR/blob/HEAD/vignettes/Part2.Tutorial.Rmd" class="external-link"><code>vignettes/Part2.Tutorial.Rmd</code></a></small>
      <div class="d-none name"><code>Part2.Tutorial.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="pre-processing">0 Pre-processing<a class="anchor" aria-label="anchor" href="#pre-processing"></a>
</h2>
<p>SMARTTR encapsulates the process of registration, importation of
segmentation data, and performs downstream analysis. Prior to this, the
imaging data must be pre-processed and cells are separately segmented in
ImageJ/FIJI. We have a separate, in-depth <a href="../articles/Part1.Segmentation.html">article</a> on our imaging
approach, parameters, and segmentation process. We suggest starting
there if you would like to walk through the pipeline from raw example
image. The remainder of this page will focus on steps relevant to
registration, segmentation data import, and downstream data analysis
using SMARTTR. We recommend completing the pre-processing and
segmentation tutorial with the example image so you can walk through the
SMARTTR tutorial with this data.</p>
<figure><img src="../reference/figures/SMARTTR_package_schematic.jpg" alt="Image" style="width: 800px; height: 400px;"><figcaption><em>SMARTTR package features</em>
</figcaption></figure><div class="section level3">
<h3 id="file-organization">0.1 File organization<a class="anchor" aria-label="anchor" href="#file-organization"></a>
</h3>
<p>Each image file is stored in a hierarchical folder structure in a
slice folder then a mouse folder:</p>
<p><code>Root folder &gt; project folder &gt; ... &gt; mouse no. &gt; slice name &gt; image file</code></p>
<p>The image files, which we also refer to as slices, are assumed to
follow the naming convention <code>mouseNo_slice.ext</code>.</p>
<p>The <code>slice</code> is a unique tag or index used to identify the
particular section when it was imaged. For example, we use an indexing
system where the first number identifies the slide number and a second
number identifies position on that slide. These numbers are separated by
an underscore. Therefore the slice <code>1_1</code> represents section
one of slide one for this animal. Of course, other indexing approaches
can be used. We create a slice name by concatenating the slice with the
mouse ID separate by an underscore to name images unambiguously.</p>
<p>For example, here is one of our image directory paths:</p>
<p><code>V:/Learned_Helplessness/Mapping_Images/Shock/733/733_1_1</code></p>
<p>And this is the file path to the image stored in that directory:</p>
<p><code>V:/Learned_Helplessness/Mapping_Images/Shock/733/733_1_1/733_1_1.lif</code></p>
<p>Here, the image or slice name is <code>733_1_1.lif</code> with the
slice no. being <code>1_1</code>. This section came from mouse 733. This
heirarchical file structure is helpful, as all segmentation files and
pre-processing files will be stored in each image folder while all mouse
object files will be stored in the parent mouse directory.</p>
</div>
<div class="section level3">
<h3 id="flatten-any-z-stacks-for-registration">0.2 Flatten any z-stacks for registration<a class="anchor" aria-label="anchor" href="#flatten-any-z-stacks-for-registration"></a>
</h3>
<p>Although cell counts may be segmented in 3D, during the registration
process, a single coronal atlas plate from the Allen Mouse Brain Atlas
is fitted to a 2D <code>.tif</code> image. Therefore, if you are
processing any z-stack images, they need to be flattened and channels
need to be collapsed into a single image used for the purpose of
registration. This step needs to be completed prior to using SMARTTR for
registration. We detail how to do this in using our pre-processing <a href="../articles/Part1.Segmentation.html">article</a></p>
</div>
</div>
<div class="section level2">
<h2 id="tutorial-outline">1 Tutorial outline<a class="anchor" aria-label="anchor" href="#tutorial-outline"></a>
</h2>
<p>In this tutorial, We will walk through the following steps using an
example preprocessed image:</p>
<ol style="list-style-type: upper-roman">
<li>Setting up the pipeline by specifying experimental parameters and
save directories.</li>
<li>The interactive registration process.</li>
<li>Importing raw segmentation data from .txt files generated from
ImageJ for multiple channels. This data will then be transformed into a
segmentation object that is compatible with <code>wholebrain</code>
functions.</li>
<li>Combining the segmentation and registration data to map cell counts
onto a standardized mouse atlas. VI Cleaning the mapped data in all the
following ways:
<ol style="list-style-type: upper-alpha">
<li>Removing cells that map outside the boundaries of the atlas.</li>
<li>Omitting regions by a default list of regions to omit.</li>
<li>Omitting new regions to omit by user-curated list for each
image.</li>
<li>Removing cells from a contralateral hemisphere per slice if the
registrations are divided by right and left hemispheres.</li>
</ol>
</li>
<li>Obtaining cell counts normalized by region volume (per
mm<sup>3</sup>) and region areas (per mm<sup>2</sup>).</li>
<li>(Optional) Splitting the hippocampal cell counts into dorsal and
ventral based on a user-defined AP coordinate ranges. IX Aggregating
cell counts across multiple animals.</li>
<li>Quality checks to look for outliers in region cell counts prior to
analysis.<br>
</li>
<li>Functions for easy analysis, based on categorical variables entered
as mouse attributes. These will include functions for region cross
correlations and network analyses.</li>
</ol>
<p>Functions for analysis and automated visualization are detailed in
our example analysis <a href="../articles/4.Example%20Analysis%20Notebook.html">notebook</a></p>
<p>These steps will be achieved through functions that operate on
objects in SMARTTR. Objects are used to store raw data and processed
data, as well as imaging, animal, and experimental parameters relevant
to the analysis. Note that in a separate article, we describe ways to
scale-up many of these steps to map images in a high-throughput manner
with scripts. The modularity of these functions lend to the creation of
many different custom workflows. We provide links to example notebooks
that others can modify for their own datasets.</p>
</div>
<div class="section level2">
<h2 id="pipeline-setup">2 Pipeline setup<a class="anchor" aria-label="anchor" href="#pipeline-setup"></a>
</h2>
<p>Okay, let’s walkthrough the pipeline with an example mouse and image
to process!</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load SMARTTR</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjin1812.github.io/SMARTTR/">SMARTTR</a></span><span class="op">)</span></span></code></pre></div>
<p>You can download our example fully pre-processed image folder <a href="https://osf.io/4qfsc" class="external-link">here</a>. This image came from mouse 733, so
create a empty folder named <code>733</code> in a location of your
choice and upzip the image folder into this folder.</p>
<div class="section level3">
<h3 id="initializing-a-mouse-object">2.1 Initializing a mouse object<a class="anchor" aria-label="anchor" href="#initializing-a-mouse-object"></a>
</h3>
<p>Let’s create an instance of a mouse object. This mouse object will
store data from mouse No. 733, so we will name it
<code>mouse_733</code>. We also want to store the important experiment
metadata related to this mouse. All of this can be done using the
<code><a href="../reference/mouse.html">SMARTTR::mouse()</a></code> constructor function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Create and store information for mouse </span></span>
<span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mouse.html">mouse</a></span><span class="op">(</span>mouse_ID <span class="op">=</span> <span class="st">"733"</span>,</span>
<span>                   sex <span class="op">=</span> <span class="st">"female"</span>,</span>
<span>                   strain <span class="op">=</span><span class="st">"129s"</span>,</span>
<span>                   experiment <span class="op">=</span> <span class="st">"learned helplessness"</span>,</span>
<span>                   group <span class="op">=</span> <span class="st">"context"</span>,   <span class="co"># Flexible attribute to encapsulate different experimental conditions, e.g. genotype, behavior conditions, that doesn't fit into other categories.</span></span>
<span>                   cohort <span class="op">=</span> <span class="st">"group_A"</span>,</span>
<span>                   output_path <span class="op">=</span> <span class="st">"P:/DENNYLABV/Michelle_Jin/Wholebrain pipeline/733"</span><span class="op">)</span>   <span class="co"># replace the output path with the path to your specific mouse folder</span></span>
<span>            </span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">)</span></span></code></pre></div>
<p>Note that when we don’t initially store the mouse metadata using
variables passed to the mouse object constructor, this metadata is
‘empty’ and there are default values stored as placeholders.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="../reference/mouse.html">mouse</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="modifying-mouse-attributes">2.2 Modifying mouse attributes<a class="anchor" aria-label="anchor" href="#modifying-mouse-attributes"></a>
</h3>
<p>If you find that you’ve made a mistake in setting the attributes for
a mouse object, don’t worry. These attributes can be easily modified. We
just need to pull out the <code>info</code> list containing the mouse
attributes and manually correct them:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get the mouse info list</span></span>
<span><span class="va">mouse_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mouse_733</span>, <span class="st">'info'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Change mouse attributes to reflect your mouse and experiment.</span></span>
<span><span class="va">mouse_info</span><span class="op">$</span><span class="va">sex</span>           <span class="op">&lt;-</span> <span class="st">'male'</span></span>
<span><span class="va">mouse_info</span><span class="op">$</span><span class="va">group</span>         <span class="op">&lt;-</span> <span class="st">'shock'</span></span>
<span><span class="va">mouse_info</span><span class="op">$</span><span class="va">cohort</span>        <span class="op">&lt;-</span> <span class="st">"group_B"</span></span>
<span></span>
<span><span class="co"># Change mouse's attributes by storing the mouse info list back into the mouse</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mouse_733</span>, <span class="st">'info'</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">mouse_info</span></span>
<span></span>
<span><span class="co"># Check the updates </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">)</span></span></code></pre></div>
<p>We have now finished setting up a mouse object and are ready to store
some imaging and automated cell count data into it!</p>
</div>
<div class="section level3">
<h3 id="initializing-a-slice-object">2.3 Initializing a slice object<a class="anchor" aria-label="anchor" href="#initializing-a-slice-object"></a>
</h3>
<p>Now we need to create a slice object. We also want to store imaging
metadata as the slice object’s attributes. For this we’ll use the
<code><a href="../reference/slice.html">SMARTTR::slice()</a></code> constructor function.</p>
<p>Before doing this, look at your image and compare it with a
standardized mouse atlas to decide what the most accurate AP coordinate
should be prior to creating the object. You can reference either the <a href="https://osf.io/cpt5w" class="external-link">SMART reference atlas</a> or <a href="http://openbrainmap.org" class="external-link">http://openbrainmap.org</a>. In our
example image, we’ve already pre-assigned the coordinate.</p>
<p>Additionally, if you need to process each hemisphere separately due
to hemisphere separation, tears, etc, it should be specified. There are
built-in ways to clean data from a right hemisphere slice and omit the
contralateral hemisphere for demonstration. If the left and right side
align well onto a single atlas plate, initialize only one slice object
and set the <code>hemisphere</code> attribute to NULL (or don’t set it,
as this is the default).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/slice.html">slice</a></span><span class="op">(</span>slice_ID <span class="op">=</span> <span class="st">"1_4"</span>,  </span>
<span>           coordinate <span class="op">=</span> <span class="op">-</span><span class="fl">2.14</span>,         <span class="co"># AP coordinate that matches best matches the images</span></span>
<span>           conversion_factor <span class="op">=</span> <span class="fl">1.0833</span>, <span class="co"># Pixel-to-micron conversion factor. </span></span>
<span>           bin <span class="op">=</span> <span class="fl">1</span>,                    <span class="co"># If the image was downsampled by a bin factor in imageJ</span></span>
<span>           z_width <span class="op">=</span> <span class="fl">9</span>,                <span class="co"># z-stack thickness in microns</span></span>
<span>           hemisphere <span class="op">=</span> <span class="cn">NULL</span>,          <span class="co"># "left", "right" or NULL (both sides). This is necessary if you are only processing one hemisphere due to hemisphere separation, tears, etc.</span></span>
<span>           channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'cfos'</span>, <span class="st">'eyfp'</span>, <span class="st">'colabel'</span><span class="op">)</span>,  <span class="co"># Channels to process</span></span>
<span>           <span class="co"># registration_path = 'V:/Michelle_Jin/Wholebrain pipeline/733/733_1_4/MAX_733_1_4.tif'# Path to the registration image. Replace with your specific path</span></span>
<span>           registration_path <span class="op">=</span> <span class="st">'P:\\DENNYLABV\\Michelle_Jin\\Wholebrain pipeline\\733\\733_1_4_fully_processed/MAX_733_1_4.tif'</span><span class="co"># Path to the registration image. Replace with your specific path</span></span>
<span>          <span class="op">)</span>  </span>
<span></span>
<span><span class="co"># Let's check the data stored correctly with print()</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span></span></code></pre></div>
<p>Note that if certain metadata were not specifically fed into the
slice object constructor, default values are take. For example
<code>left_regions_excluded</code> list regions that are omitted by
default, including the fiber tracts, ventricular systems (VS), and layer
1 of all cortical regions. You can use the <a href="http://atlas.brain-map.org/atlas?atlas=1&amp;plate=100960520" class="external-link">Allen
Mouse Brain Ontology</a> your own list of default regions to
exclude.</p>
</div>
<div class="section level3">
<h3 id="adding-slice-objects-to-mouse-objects">2.4 Adding slice objects to mouse objects<a class="anchor" aria-label="anchor" href="#adding-slice-objects-to-mouse-objects"></a>
</h3>
<p>We are ready to bundle our slice information with our mouse. But
first…</p>
<p>Type the code below into the R console:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">`mouse_733$`</span></span></code></pre></div>
<p>You should see that a named list called <code>slices</code> pops up
and you can complete the suggestion by hitting TAB. The <code>$</code>
operator is very useful for accessing any named element in a list. Right
now, the <code>slices</code> list is NULL, because it is empty and
doesn’t contain anything.</p>
<blockquote>
<p>Tip: You can use the <code>$</code> operator to look at named
elements in a mouse.</p>
</blockquote>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check the length of slices in a mouse first</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">)</span></span></code></pre></div>
<p>That will change soon after we add the slice into our mouse. Let’s
check out the help page of the function <code><a href="../reference/add_slice.html">add_slice()</a></code>.</p>
<blockquote>
<p>Tip: Check the “Usage” or “Examples” section for a code example of
how to use a particular function in a package</p>
</blockquote>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="op">?</span><span class="va">add_slice</span></span></code></pre></div>
<p>Now that we’ve read how to use the function, let’s add our slice to
our mouse with the line below:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_slice.html">add_slice</a></span><span class="op">(</span><span class="va">mouse_733</span>, <span class="va">s</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check the length of slices now</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Access the new slice information with the code below</span></span>
<span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">$</span><span class="va">`1_4`</span></span></code></pre></div>
<blockquote>
<p>Note that if you’ve changed computers and you find the location of
your mouse folder has changed in some way, e.g. different drive mapping
letters on Windows or different OS, you can adjust for this using the
<code><a href="../reference/reset_mouse_root.html">reset_mouse_root()</a></code> function.</p>
</blockquote>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Change to the correct drive letter</span></span>
<span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/reset_mouse_root.html">reset_mouse_root</a></span><span class="op">(</span><span class="va">mouse_733</span>, input_path <span class="op">=</span> <span class="st">"C:/Michelle_Jin/Wholebrain pipeline/733"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="interactive-registration">3 Interactive registration<a class="anchor" aria-label="anchor" href="#interactive-registration"></a>
</h2>
<p>Now we are ready to begin registering this slice! Registration is the
process of aligning your imaging dataset with a standardized mouse
atlas. The wholebrain package does this by generating a set of
correspondance points around the contours of the brain in your image,
and aligning it with analagous points around an atlas plate from the
standardized mouse atlas.</p>
<p>Before we register we must first check that the contours of our brain
sample can be detected properly. A proper outline of the brain contours
are necessary to generate a good first-guess of correspondance point
placement.</p>
<div class="section level3">
<h3 id="detecting-brain-contours">3.1 Detecting brain contours<a class="anchor" aria-label="anchor" href="#detecting-brain-contours"></a>
</h3>
<p>To get a good outline of our brain, we need to feed a
<code>filter</code> list which contains various parameters used to
segment feature of interest in an image with wholebrain functions. We
can autogenerate a default <code>filter</code> list with
<code><a href="../reference/filter.html">SMARTTR::filter</a></code>. Within this filter, we need to modify a
parameter called the <code>brain.threshold</code> which is critical for
detection the contours of the brain. We will adjust and check the
effects of changing the <code>brain.threshold</code> parameter using the
function <code><a href="../reference/adjust_brain_outline.html">adjust_brain_outline()</a></code> This function uses a
default <code>brain.threshold</code> of 10 and pops up a window showing
the detected contours in a blue line.</p>
<p>If the contours are unsatisfactory, press “esc” or “Q” to exit from
the popup and you can use the interactive console interface to modify
the value. I recommend modifying the value in steps of +/- 2. we will
pass this filter to<code><a href="../reference/register.html">SMARTTR::register()</a></code> so the function
knows which <code>brain.threshold</code> to use. Note that another GUI
window pops up to modify various filter parameters, however it is quite
buggy and often crashes I would recommend using the console
interface.</p>
<p>If your imaging parameters are standardized. You may not need to
adjust your filter on an image by image basis. Below we use the
brain.threshold of 2 to detect the contours of our image.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># store the default filter list from the SMARTTR package</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu">SMARTTR</span><span class="fu">::</span><span class="va"><a href="../reference/filter.html">filter</a></span></span>
<span></span>
<span><span class="co"># Manually adjust the brain.threshold in the filter list </span></span>
<span><span class="va">filter</span><span class="op">$</span><span class="va">brain.threshold</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span></span>
<span><span class="co"># Pass a slice object as an argument</span></span>
<span><span class="co"># Interactively adjust the brain threshold until it looks good</span></span>
<span><span class="co"># Store the output as a filter</span></span>
<span><span class="va">filter</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/adjust_brain_outline.html">adjust_brain_outline</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">$</span><span class="va">`1_4`</span>, filter <span class="op">=</span> <span class="va">filter</span><span class="op">)</span></span></code></pre></div>
<figure><img src="../reference/figures/4.733_4_reg_threshold.jpg" alt="Image" style="width: 400px;"><figcaption><em>Brain contour detection in blue.</em>
</figcaption></figure>
</div>
<div class="section level3">
<h3 id="registration-of-a-slice">3.2 Registration of a slice<a class="anchor" aria-label="anchor" href="#registration-of-a-slice"></a>
</h3>
<p>The <code><a href="../reference/register.html">register()</a></code> function is one of the generic functions
of the package. Because of this, what the function does depends on the
type of objects being fed into it. The <code><a href="../reference/register.html">register()</a></code> function
can be used on both <code>slice</code> and <code>mouse</code> objects.
Examples of how to used this function with <code>slice</code> or
<code>mouse</code> objects are found under the Usage section.</p>
<p>Pull up the help page with the code below:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">?</span><span class="va">register</span></span></code></pre></div>
<p>If you use a <code>mouse</code> object with the function you need to
specify which <code>slice_ID</code> and which <code>hemisphere</code>
you want to register, because a <code>mouse</code> object may contain
many slices.</p>
<p>Let register our example image using a mouse object! The code below
will look for slice <code>1_4</code> in <code>mouse_733</code> and apply
the filter settings with the brain.threshold. Note that the
<code>mouse</code> object may contain many slices, so that is why we
need to specify which <code>slice_ID</code> and which
<code>hemisphere</code> to register</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/register.html">register</a></span><span class="op">(</span><span class="va">mouse_733</span>, </span>
<span>                      slice_ID <span class="op">=</span> <span class="st">"1_4"</span>,</span>
<span>                      hemisphere <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                      filter <span class="op">=</span> <span class="va">filter</span><span class="op">)</span></span></code></pre></div>
<figure><img src="../reference/figures/5.733_4_registration_uncorrected.jpg" alt="Image" style="width: 500px;"><figcaption><em>First pass registration.</em>
</figcaption></figure><p>A graphics window should pop up showing the atlas superimposed on the
registration image in two outlines. The yellow side is “atlas space” so
the correspondence points appear around the boundaries of the atlas. The
purple side is “image space” so correspondence points should fit around
the contours of the actual brain tissue in the image. One this window
has loaded, there should be an interactive console interface allowing
for the addition, removal, and changing of these default correspondence
points. You can read more about the fitting process in the original
wholebrain <a href="https://www.nature.com/articles/s41593-017-0027-7" class="external-link">publication</a>.</p>
<p>At this point, you may find it useful to save all your hard work
after perfecting the registration. You can save the mouse object to its
output folder with the command below.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/save_mouse.html">save_mouse</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">)</span></span></code></pre></div>
<p>Add the <code>timestamp</code> parameter to save the mouse object
with today’s date:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/save_mouse.html">save_mouse</a></span><span class="op">(</span><span class="va">mouse_733</span>, timestamp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>I recommend always saving with a timestamp so you never lose more
than a day’s worth of work if you accidentally overwrite something.</p>
</div>
</div>
<div class="section level2">
<h2 id="add-segmentation-data">4 Add segmentation data<a class="anchor" aria-label="anchor" href="#add-segmentation-data"></a>
</h2>
<div class="section level3">
<h3 id="import-raw-imagej-data">4.1 Import raw ImageJ data<a class="anchor" aria-label="anchor" href="#import-raw-imagej-data"></a>
</h3>
<p>The segmentation data from ImageJ is stored into .txt files. We can
use the <code><a href="../reference/import_segmentation_ij.html">import_segmentation_ij()</a></code> generic function to import
the raw data from ImageJ.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_segmentation_ij.html">import_segmentation_ij</a></span><span class="op">(</span><span class="va">mouse_733</span>,</span>
<span>                                    slice_ID <span class="op">=</span> <span class="st">'1_4'</span>,</span>
<span>                                    hemisphere <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                    channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eyfp'</span>, <span class="st">'cfos'</span>, <span class="st">'colabel'</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The console output indicating successful importation of segmentation
data should look like below:</p>
<pre><code>Imported the following files: 

[1] "M_G_eYFP_733_1_4.txt"
[1] "Q_G_eYFP_733_1_4_eYFP.txt"
Imported the following files: 

[1] "M_C2_cfos_733_1_4.txt"
[1] "Q_C2_cfos_733_1_4_cfos.txt"
[1] "733_1_4cfos_SpotSegmentation_ColocOnly.txt"
[1] "M_733_1_4_Fast_G_eYFP_LabelImage_C1_16bit.txt"</code></pre>
<p>Note that currently, this importation function relies on the output
of the txt files output from the macros used to segment cells. The
macros automatically name the segmentation output txt files for each
channel and this import function recognizes the names of the txt files.
Since we often stain for <code>eyfp</code> and <code>cfos</code>, and
their colocalization <code>colabel</code>, these three are hard coded
channel names in the pipeline.</p>
<p>However, there is built-in capability to include additional custom
channels. The generalized segmentation macro found <a href="https://osf.io/bek56" class="external-link">here</a> will recursively segment the
channel specified in a .tiff image. The output segmentation txt files
can be imported with <code><a href="../reference/import_segmentation_custom.html">import_segmentation_custom()</a></code>. Check
out the function documentation for more information.</p>
</div>
<div class="section level3">
<h3 id="creating-a-segmentation-object">4.2 Creating a segmentation object<a class="anchor" aria-label="anchor" href="#creating-a-segmentation-object"></a>
</h3>
<p>After importing the raw segmentation data, the data needs to be
reformatted to be compatible with the registration information using
<code>wholebrain</code> functions. This is simply done using the
<code><a href="../reference/make_segmentation_object.html">make_segmentation_object()</a></code> function:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_segmentation_object.html">make_segmentation_object</a></span><span class="op">(</span><span class="va">mouse_733</span>,</span>
<span>                                      slice_ID <span class="op">=</span> <span class="st">'1_4'</span>,</span>
<span>                                      hemisphere <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                      channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eyfp'</span>, <span class="st">'cfos'</span>, <span class="st">"colabel"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="mapping-cells-to-atlas-space">5 Mapping cells to atlas space<a class="anchor" aria-label="anchor" href="#mapping-cells-to-atlas-space"></a>
</h2>
<div class="section level3">
<h3 id="forward-warp-data-to-atlas-space">5.1 Forward warp data to atlas space<a class="anchor" aria-label="anchor" href="#forward-warp-data-to-atlas-space"></a>
</h3>
<p>We are ready to map our segmentation data onto atlas space! We will
forward warp our segmented cells onto atlas space with the
<code><a href="../reference/map_cells_to_atlas.html">map_cells_to_atlas()</a></code> generic function.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/map_cells_to_atlas.html">map_cells_to_atlas</a></span><span class="op">(</span><span class="va">mouse_733</span>,</span>
<span>                                slice_ID <span class="op">=</span> <span class="st">'1_4'</span>,</span>
<span>                                hemisphere <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                                channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'eyfp'</span>, <span class="st">'cfos'</span>, <span class="st">"colabel"</span><span class="op">)</span>,</span>
<span>                                clean <span class="op">=</span>  <span class="cn">FALSE</span>,</span>
<span>                                display <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="cleaning-mapped-cell-data">5.2 Cleaning mapped cell data<a class="anchor" aria-label="anchor" href="#cleaning-mapped-cell-data"></a>
</h3>
<p>For all slices, there may be an automatic list of regions to exclude
for each hemisphere. This is automatically set as a slice attribute when
you create it and you can edit it like any other slice attribute as
demonstrated earlier. In the slice attributes, a list of these regions
can be accessed with <code>$left_regions_excluded</code> and
<code>$right_regions_excluded</code>.</p>
<p>When you run the <code>exclude_anatomy</code> function, it will
automatically omit the regions for each hemisphere in these lists. The
commands below prints the default excluded regions for the left and
right hemispheres.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Print the default regions excluded list for the right hemisphere</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">$</span><span class="va">`1_4`</span>, <span class="st">"info"</span><span class="op">)</span><span class="op">$</span><span class="va">right_regions_excluded</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the default regions excluded list for the left hemisphere</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">$</span><span class="va">`1_4`</span>, <span class="st">"info"</span><span class="op">)</span><span class="op">$</span><span class="va">left_regions_excluded</span><span class="op">)</span></span></code></pre></div>
<p>You can directly edit this list as an attribute to add additional
regions to omit per hemisphere for each slice object. You simply need to
add the region acronym from the Allen Mouse Brain Atlas Ontology. In the
example below, we will pretend there was a rip in the primary
somatosensory cortex on the right hemisphere and will add this as a
region to exclude.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get default list</span></span>
<span><span class="va">right_regions_excluded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">$</span><span class="va">`1_4`</span>, <span class="st">"info"</span><span class="op">)</span><span class="op">$</span><span class="va">right_regions_excluded</span></span>
<span></span>
<span><span class="co"># Append the primary somatosensory area to the list of regions to exclude </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">slices</span><span class="op">$</span><span class="va">`1_4`</span>, <span class="st">"info"</span><span class="op">)</span><span class="op">$</span><span class="va">right_regions_excluded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">right_regions_excluded</span>, <span class="st">"SSp"</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively, you can enter additional regions to exclude directly
as an argument into the <code><a href="../reference/exclude_anatomy.html">exclude_anatomy()</a></code> function. Pull up
the help page of <code>exclude_anatomy</code> to understand how to
perform the following capabilities:</p>
<ul>
<li>exclude the contralateral hemisphere for slices with either a
‘right’ or ‘left’ hemisphere attribute. This automatically removes
anything registered to the unused hemisphere.</li>
<li>clean up cell counts that map outside of the brain contours</li>
<li>exclude cell counts from layer 1 of the cortex</li>
<li>manually specify additional regions we want to exclude for each
hemisphere. Below we exclude the secondary motor area on the left
hemisphere</li>
</ul>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exclude_anatomy.html">exclude_anatomy</a></span><span class="op">(</span><span class="va">mouse_733</span>, </span>
<span>                             slice_ID <span class="op">=</span> <span class="st">'1_4'</span>,</span>
<span>                             hemisphere <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                             channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"eyfp"</span>, <span class="st">"cfos"</span>, <span class="st">"colabel"</span><span class="op">)</span>,</span>
<span>                             clean <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                             exclude_left_regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MOs"</span><span class="op">)</span>,</span>
<span>                             exclude_right_regions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SS"</span><span class="op">)</span>,</span>
<span>                             exclude_layer_1 <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                             exclude_hemisphere <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                             plot_filtered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>You can visualize the filtered counts when you set the
<code>plot_filtered</code> parameter to <code>TRUE</code>. Note however,
that sometimes the graphical rendering will flip the left and right
sides.</p>
</div>
</div>
<div class="section level2">
<h2 id="normalize-cell-counts-by-region">6 Normalize cell counts by region<a class="anchor" aria-label="anchor" href="#normalize-cell-counts-by-region"></a>
</h2>
<p>Getting cell counts per region normalized by volume or area in
mm<sup>3</sup> or mm<sup>2</sup> respectively.</p>
<div class="section level3">
<h3 id="get-slice-volumes">6.1 Get slice volumes<a class="anchor" aria-label="anchor" href="#get-slice-volumes"></a>
</h3>
<p>In order to get cell counts per region in each mouse normalized by
volume, the exact volume of each region in each slice needs to be
calculated. This is accomplished with the function
<code><a href="../reference/get_registered_volumes.html">get_registered_volumes()</a></code>. The function will automatically
calculate region volumes per hemisphere for each slice.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Calculate region volumes for the full slice</span></span>
<span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_registered_volumes.html">get_registered_volumes</a></span><span class="op">(</span><span class="va">mouse_733</span>,</span>
<span>                                    slice_ID <span class="op">=</span> <span class="st">"1_4"</span>,</span>
<span>                                    hemisphere <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="get-a-combined-cell-data-table">6.2 Get a combined cell data table<a class="anchor" aria-label="anchor" href="#get-a-combined-cell-data-table"></a>
</h3>
<p>The <code><a href="../reference/get_cell_table.html">get_cell_table()</a></code> function will aggregate all forward
warped cell counts across all slices into one data frame named
<code>cell_table</code>. This can be especially useful for plotting
purposes.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_cell_table.html">get_cell_table</a></span><span class="op">(</span><span class="va">mouse_733</span>, channels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cfos"</span>, <span class="st">"eyfp"</span>, <span class="st">"colabel"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>You can access the cell table for each channel with the
<code>$</code> operator (e.g. <code>mouse_325$cell_table$cfos</code>).
We can use this aggregated dataset if we want to plot an interactive
“glass brain” plot of all slices in the mouse.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot an interactive 3D plot of the cfos channel</span></span>
<span><span class="fu">SMART</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SMART/man/glassbrain2.html" class="external-link">glassbrain2</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">cell_table</span><span class="op">$</span><span class="va">cfos</span>, jitter <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This is a useful function to show an interactive representation of
all the cells cells mapped in a single animal.</p>
</div>
<div class="section level3">
<h3 id="get-normalized-cell-counts">6.3 Get normalized cell counts<a class="anchor" aria-label="anchor" href="#get-normalized-cell-counts"></a>
</h3>
<p>Once <code><a href="../reference/get_registered_volumes.html">get_registered_volumes()</a></code> has been run for all the
slice objects within a mouse, and the forward warped counts have been
combined using <code><a href="../reference/get_cell_table.html">get_cell_table()</a></code>, we can use the function
<code><a href="../reference/normalize_cell_counts.html">normalize_cell_counts()</a></code> to get normalized cell counts per
volume (mm<sup>3</sup>) and per area (mm<sup>2</sup>).</p>
<p>This information is stored as a named element in the mouse called
<code>normalized_counts</code>.</p>
<blockquote>
<p>Tip: The parameter <code>simplify_regions</code> will further
collapse the normalized cell counts by certain keywords (e.g. “layer” or
“stratum”). If a region name is detected to have one of these keywords,
it will merge counts with its parent structure until there are no more
keywords found. This reduces the overwhelming amount of substructures
that we can compare and helps simplify our analysis.</p>
</blockquote>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mouse_733_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normalize_cell_counts.html">normalize_cell_counts</a></span><span class="op">(</span><span class="va">mouse_733</span>, </span>
<span>                                   combine_hemispheres <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                   split_hipp_DV <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                   simplify_regions <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Print preview of normalized counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mouse_733_0</span><span class="op">$</span><span class="va">normalized_counts</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="split-hippocampal-counts-into-dorsalventral-counts-optional">6.4 Split hippocampal counts into Dorsal/Ventral counts
(Optional)<a class="anchor" aria-label="anchor" href="#split-hippocampal-counts-into-dorsalventral-counts-optional"></a>
</h3>
<p>Sometimes, we want to further subdivide the hippocampus into
<em>dorsal</em> and <em>ventral</em> subregions. The
<code>wholebrain</code> atlas plates are derived from the Allen Mouse
Brain Atlas, which does not intrinsically have <em>dorsal</em> and
<em>ventral</em> subdivisions for the hippocampus. Our current strategy
is to use an AP coordinate cutoff, where hippocampal counts anterior to
this cutoff are considered <em>dorsal</em> and posterior to this cutoff
are considered <em>ventral</em>. You can accomplish this by setting the
parameters <code>split_hipp_DV = TRUE</code>
and<code>DV_split_AP_thresh = -2.7</code> in the
<code>normalize_cell_counts</code> function.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">mouse_733</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normalize_cell_counts.html">normalize_cell_counts</a></span><span class="op">(</span><span class="va">mouse_733</span>, </span>
<span>                                     combine_hemispheres <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>                                     simplify_regions <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                     split_hipp_DV <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                     DV_split_AP_thresh <span class="op">=</span> <span class="op">-</span><span class="fl">2.7</span><span class="op">)</span></span>
<span><span class="co"># Print preview of normalized counts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mouse_733</span><span class="op">$</span><span class="va">normalized_counts</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="aggregating-mouse-data">7 Aggregating mouse data<a class="anchor" aria-label="anchor" href="#aggregating-mouse-data"></a>
</h2>
<div class="section level3">
<h3 id="initializing-an-experiment-object">7.1 Initializing an experiment object<a class="anchor" aria-label="anchor" href="#initializing-an-experiment-object"></a>
</h3>
<p>Once you’ve registered enough mice, you can begin adding them into an
experiment object. Creating an experiment object is very similar to the
way we created mouse and slice objects with one exception–there are
certain experimental attributes that are meant to be autopopulated when
we add a mouse object to it and should be left alone during object
construction.</p>
<p>For example, if multiple mice are added to an experiment object from
three different <code>drug</code> conditions, the experiment object’s
attribute <code>drug_groups</code> will consist of the names of the
three drugs given. Check the help page to see which experiment
attributes are autogenerated. You’ll see that the
<code>experiment_name</code>, <code>experimenters</code>, and
<code>output_path</code> parameters are the only ones we need to be set
manually.</p>
<p>Additionally, know that adding mice to an experiment will keep only
the processed neural mapping information, not the individual slice
information. This is to ensure that unnecessary computer memory isn’t
being used during analysis. Therefore, any changes you want to make to
cleaning up or modifying individual slice data should be done at the
mouse object level.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Initialize an experiment object</span></span>
<span><span class="va">my_experiment</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/experiment.html">experiment</a></span><span class="op">(</span>experiment_name <span class="op">=</span> <span class="st">"Learned Helplessness"</span>,</span>
<span>                            experimenters <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"MJ"</span>, <span class="st">"MyInitials"</span><span class="op">)</span>,</span>
<span>                            output_path <span class="op">=</span> <span class="st">"V:\\Michelle Jin\\path_to_output_folder"</span><span class="op">)</span> <span class="co">#Set this to a location where you want your figures/analysis output to save</span></span>
<span> </span>
<span><span class="co"># Add a mouse to the experiment</span></span>
<span><span class="va">my_experiment</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_mouse.html">add_mouse</a></span><span class="op">(</span><span class="va">my_experiment</span>, <span class="va">mouse_733</span><span class="op">)</span></span></code></pre></div>
<p>Just like a mouse object, you can save an experiment object, with or
without a timestamp.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/save_experiment.html">save_experiment</a></span><span class="op">(</span><span class="va">my_experiment</span>, timestamp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="combine-cell-counts-across-all-the-mice-in-an-experiment">7.2 Combine cell counts across all the mice in an experiment<a class="anchor" aria-label="anchor" href="#combine-cell-counts-across-all-the-mice-in-an-experiment"></a>
</h3>
<p>Once you’ve added enough mice to perform an analysis, we want to
aggregate all the data for each mouse together into one dataframe to
perform analysis on.</p>
<p>For now we will load a saved example experiment object named
<code>lh</code> that already contains all the mapped mouse object data
from our learned helplessness mapping experiment.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load the presaved data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"P:\\DENNYLABV\\Michelle_Jin\\Wholebrain pipeline\\LH_analysis\\learned_helplessness_experiment.RDATA"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Print the names of the mice stores in the learned helplessness experiment object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">lh</span><span class="op">$</span><span class="va">mice</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Aggregating the normalized cell counts across mice into one dataframe
is done with the <code>combine_norm_cell_counts()</code> function.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/combine_cell_counts.html">combine_cell_counts</a></span><span class="op">(</span><span class="va">lh</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'groups'</span>, <span class="st">"sex"</span>, <span class="st">"age"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><code>by</code> is a special parameter that will allow up to take
advantage of the many mouse attributes that we have recorded during
creation of a mouse object. It is a vector of the mouse attributes we
will use to split our dataset into subgroups for comparison. In the
example above, we use the <code>group</code> mouse attributes to compare
<code>Shock</code> and <code>Context</code> groups which received
inescapable shock and context training, respectively. If there were
additional groupings of interest, such as splitting males and females to
look at sex differences, you can include the <code>sex</code> attribute
into the vector, e.g. <code>c('group', 'sex')</code>. Sometimes, certain
attributes like <code>drug</code> may not apply to your experiment, so
<code>by</code> should only include the variables that you intend on
using for group comparisons during analysis to avoid cluttering your
combined dataframe. For consistency in the functions used to filter out
subgroups, the values of the attributes will all be converted to
strings.</p>
</div>
</div>
<div class="section level2">
<h2 id="quality-checking-saving-your-data">8 Quality checking &amp; saving your data<a class="anchor" aria-label="anchor" href="#quality-checking-saving-your-data"></a>
</h2>
<p>The quality of the segmentation data may depend on many factors
including immunolabelling quality, the sectioning and mounting
technique, and performance of the segmentation algorithm. We also want
to check for “statistical quality” and ensure that there are enough mice
per group within a single brain region to compare. There are a few of
functions we can use to check the data which can optionally use to clean
our mapped dataset. Additionally, both of them contain <code>log</code>
parameter which automatically export to the experiment folder a list of
regions removed as a .csv file which don’t meet the quality checks.</p>
<div class="section level3">
<h3 id="check-for-outlier-counts">8.1 Check for outlier counts<a class="anchor" aria-label="anchor" href="#check-for-outlier-counts"></a>
</h3>
<p>The function <code><a href="../reference/find_outlier_counts.html">find_outlier_counts()</a></code> will first organize
counts into sub analysis groups stratified based on the <code>by</code>
parameter. Then the mean cell counts for each analysis group and their
standard deviation are calculated. If any regions counts for a mouse
exceed greater than <code>n_sd</code> (default = 2) for their analysis
group, the region and mouse will be marked as an outlier. If
<code>log = TRUE</code> then, the output is stored in a csv file with
the file stem <code>region_count_outliers_[channel]</code>. This may be
helpful to look back at the raw data and examine whether the
segmentation algorithm is doing a good job around these regions for a
given mouse.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/find_outlier_counts.html">find_outlier_counts</a></span><span class="op">(</span><span class="va">lh</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'groups'</span>, <span class="st">'sex'</span>, <span class="st">'age'</span><span class="op">)</span>, n_sd <span class="op">=</span> <span class="fl">2</span>, remove <span class="op">=</span> <span class="cn">TRUE</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="checking-for-the-minimum-n-number">8.2 Checking for the minimum n number<a class="anchor" aria-label="anchor" href="#checking-for-the-minimum-n-number"></a>
</h3>
<p>If you want to check that each analysis subgroup has a minimum n
represented per brain region, you can use the function
<code><a href="../reference/enough_mice_per_group.html">enough_mice_per_group()</a></code>. This function contains
<code>by</code> parameter as well. Additionally, This function also
automatically keeps only the common regions that are found across all
comparison groups.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enough_mice_per_group.html">enough_mice_per_group</a></span><span class="op">(</span><span class="va">lh</span>, by <span class="op">=</span> <span class="st">"group"</span>, min_n <span class="op">=</span> <span class="fl">4</span>, remove <span class="op">=</span> <span class="cn">TRUE</span>, log <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="saving-your-experiment">8.3 Saving your experiment<a class="anchor" aria-label="anchor" href="#saving-your-experiment"></a>
</h3>
<p>If you would like to save your experiment object, just run the
function below!</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/save_experiment.html">save_experiment</a></span><span class="op">(</span><span class="va">lh</span><span class="op">)</span></span></code></pre></div>
<p>If you use the <code>timestamp</code> parameter, the experiment
object with automatically save with the date as a way to uniquely
timestamp your progress.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/save_experiment.html">save_experiment</a></span><span class="op">(</span><span class="va">lh</span>, timestamp <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This concludes the end of the mapping tutorial! Check out section <a href="../articles/Part4.Example_Analysis_Notebook.html">4. Example
analysis notebook</a> to see how we apply the analysis and visualization
functions in SMARTTR to this dataset.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michelle Jin.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
