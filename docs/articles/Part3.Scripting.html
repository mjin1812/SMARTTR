<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SMARTR">
<title>3. Scripting &amp; notebooks • SMARTR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="3. Scripting &amp; notebooks">
<meta property="og:description" content="SMARTR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SMARTR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/SMARTR.html">Get started</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Part1.Segmentation.html">1. Imaging, segmentation, and preprocessing</a>
    <a class="dropdown-item" href="../articles/Part2.Tutorial.html">2. Mapping Tutorial</a>
    <a class="dropdown-item" href="../articles/Part3.Scripting.html">3. Scripting &amp; notebooks</a>
    <a class="dropdown-item" href="../articles/Part4.Example_Analysis_Notebook.html">4. Example analysis notebook</a>
    <a class="dropdown-item" href="../articles/Part5.FAQ.html">5. FAQ</a>
    <a class="dropdown-item" href="../articles/Part6.Development.html">6. Development environment</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/mjin1812/SMARTR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>3. Scripting &amp; notebooks</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mjin1812/SMARTR/blob/HEAD/vignettes/Part3.Scripting.Rmd" class="external-link"><code>vignettes/Part3.Scripting.Rmd</code></a></small>
      <div class="d-none name"><code>Part3.Scripting.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="scripting">Scripting<a class="anchor" aria-label="anchor" href="#scripting"></a>
</h2>
<p>A little bit of scripting can go quite a long way in scaling up this
pipeline. In this section, we’ll walk through some standard scripts for
batch object creation and looping through registration correction for
each mouse. Once all the registrations in a mouse are finished, we also
have scripts that perform batch segmentation importation, cleaning of
regions to omit, and mapping. For this section, we recommend spending a
little time learning R syntax to better understand and even modify these
scripts for your own use. <a href="https://swirlstats.com/" class="external-link">Swirl</a> is
an excellent interactive resource to check out.</p>
<div class="section level3">
<h3 id="batch-object-creation">Batch object creation<a class="anchor" aria-label="anchor" href="#batch-object-creation"></a>
</h3>
<p>Although the organization of data into objects ensure a logical and
heirarchical data management structure in SMARTR, it can be super
tedious to manually create each mouse and slice object and store each
slice object into the appropriate mouse object. Here we provide a script
that essentially performs this process automatically after reading in an
excel file where users can more easily enter and edit metadata for mouse
and slice object. Download the template <a href="https://osf.io/zdm5w" class="external-link">here</a>!</p>
<p>When you open the template, you will see the left side (green colored
columns) includes columns to populate the mouse metadata.</p>
<figure><img src="../reference/figures/mouse_batch_create_sheet.JPG" alt="Image" style="width: 650px; height: 75px;"><figcaption><em>Mouse metadata columns </em>
</figcaption></figure><p>The right side (blue colored columns) includes columns where slice
metadata is populated. Each row in the sheet will be read and used to
create a new slice object.</p>
<figure><img src="../reference/figures/slice_batch_create_sheet.JPG" alt="Image" style="width: 900px; height: 60px;"><figcaption><em>Slice metadata columns</em>
</figcaption></figure><p>Paste over the example entries with your own mouse and slice
parameters.</p>
<p>For the slice metadata, the registration path column includes a
formula to auto create a path to the max projection image from the
pre-processing steps. You can drag this formula down to autopopulate the
column. If you have a separate process and naming structure to create a
flattened image, you can override this formula. Additionally, the
left_regions_excluded and right_regions_excluded columns allow for entry
of a default custom list of regions to exclude from each hemisphere. If
left empty, the default list is used. If you are going to append your
own acronyms, please make sure there are no spelling mistakes!</p>
<p>Once you’re done entering into the spread sheet, either <a href="https://osf.io/fkgw8" class="external-link">download</a> or copy and paste the script
below into R.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># This batch script:</span></span>
<span><span class="co"># Reads the parameters from a .xlsx file</span></span>
<span><span class="co"># Auto creates the mouse and slice objects</span></span>
<span><span class="co"># Automatically saves the mouse objects in designated mouse output folder</span></span>
<span></span>
<span></span>
<span><span class="co"># Dependencies:</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mjin1812.github.io/SMARTR/" class="external-link">SMARTR</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/markvanderloo/stringdist" class="external-link">stringdist</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org" class="external-link">readxl</a></span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Choose the batch excel file</span></span>
<span><span class="va">xlsx_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.choose.html" class="external-link">file.choose</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#_____________________ autocreate mouse objects _______________________________</span></span>
<span><span class="co"># Autocreate each mouse object and save in the mouse directory as it's output folder</span></span>
<span></span>
<span><span class="co"># Read sheet, select mouse cols and collapse into distinct values</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html" class="external-link">read_excel</a></span><span class="op">(</span><span class="va">xlsx_path</span>,</span>
<span>                 na <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"NA"</span><span class="op">)</span>,</span>
<span>                 col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mouse_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">==</span> <span class="st">"slice"</span><span class="op">)</span> <span class="op">-</span> <span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">slice_cols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">==</span> <span class="st">"slice"</span><span class="op">)</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mice_info</span> <span class="op">&lt;-</span> <span class="va">df</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">mouse_cols</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">m</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mice_info</span><span class="op">$</span><span class="va">mouse</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">my_mouse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mouse.html">mouse</a></span><span class="op">(</span>mouse_ID <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">mouse</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    sex <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">sex</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    age <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">age</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    cre_genotype <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">cre_genotype</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    reporter <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">reporter</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    strain <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">strain</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    experiment <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">experiment</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    group <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">group</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    drug <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">drug</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    cohort <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">cohort</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,</span>
<span>                    output_path <span class="op">=</span> <span class="va">mice_info</span><span class="op">$</span><span class="va">mouse_path</span><span class="op">[</span><span class="va">m</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Save the mouse, then remove it from the environment</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/assign.html" class="external-link">assign</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"mouse_"</span>, <span class="va">mice_info</span><span class="op">$</span><span class="va">mouse</span><span class="op">[</span><span class="va">m</span><span class="op">]</span><span class="op">)</span>, <span class="va">my_mouse</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"save_mouse(mouse_"</span>, <span class="va">mice_info</span><span class="op">$</span><span class="va">mouse</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,<span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rm(mouse_"</span>, <span class="va">mice_info</span><span class="op">$</span><span class="va">mouse</span><span class="op">[</span><span class="va">m</span><span class="op">]</span>,<span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#_____________________ autocreate slice objects _______________________________</span></span>
<span></span>
<span><span class="co"># For each new slice</span></span>
<span><span class="co"># Detect if the mouse has changed</span></span>
<span><span class="co"># Load the current mouse mouse</span></span>
<span><span class="co"># Create and populate the slice info</span></span>
<span><span class="co"># Add it to the mouse</span></span>
<span><span class="co"># Check if the next slice belongs to the same mouse</span></span>
<span><span class="co"># If not, save the mouse and delete it from the environment</span></span>
<span><span class="co"># Move onto next mouse</span></span>
<span></span>
<span><span class="va">change_mouse</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">s</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">slice</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">change_mouse</span> <span class="op">&amp;&amp;</span> <span class="va">s</span> <span class="op">!=</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># search, save, then remove current mouse</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"save_mouse("</span>, <span class="va">cur_mouse</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"rm("</span>, <span class="va">cur_mouse</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Load the new mouse</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">mouse_path</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"mouse_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">mouse</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="st">".RDATA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">cur_mouse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/stringdist/man/amatch.html" class="external-link">amatch</a></span><span class="op">(</span><span class="st">"mouse_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span>, maxDist <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">change_mouse</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">s</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Load the new mouse</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">mouse_path</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"mouse_"</span>, <span class="va">df</span><span class="op">$</span><span class="va">mouse</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>, <span class="st">".RDATA"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># current mouse</span></span>
<span>    <span class="va">cur_mouse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/stringdist/man/amatch.html" class="external-link">amatch</a></span><span class="op">(</span><span class="st">"mouse_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="op">)</span>, maxDist <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">change_mouse</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Convert the hemispheres column to lower case</span></span>
<span>  <span class="va">df</span><span class="op">$</span><span class="va">hemisphere</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_chr</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">hemisphere</span>, <span class="va">tolower</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">hemisphere</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">==</span> <span class="st">"right"</span> <span class="op">||</span> <span class="va">df</span><span class="op">$</span><span class="va">hemisphere</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op">==</span> <span class="st">"left"</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">hemi</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">hemisphere</span><span class="op">[</span><span class="va">s</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">hemi</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Convert the channels to a vector</span></span>
<span>  <span class="va">channels</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">channels</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>  <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="va">.</span>,<span class="st">","</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span></span>
<span>  <span class="co"># Take the default set of regions to exclude if not specified explicitly in the sheet</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">left_regions_excluded</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">left_regions_excluded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"layer 1"</span>, <span class="st">"fiber tracts"</span>, <span class="st">"VS"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">left_regions_excluded</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">left_regions_excluded</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="va">.</span>,<span class="st">","</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">right_regions_excluded</span><span class="op">[</span><span class="va">s</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">right_regions_excluded</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"layer 1"</span>, <span class="st">"fiber tracts"</span>, <span class="st">"VS"</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">right_regions_excluded</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">$</span><span class="va">right_regions_excluded</span><span class="op">[</span><span class="va">s</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">" "</span>, <span class="st">""</span>, <span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="va">.</span>,<span class="st">","</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Populate the slice information</span></span>
<span>  <span class="va">my_slice</span> <span class="op">&lt;-</span> <span class="fu">SMARTR</span><span class="fu">::</span><span class="fu"><a href="../reference/slice.html">slice</a></span><span class="op">(</span>slice_ID <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">slice</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,</span>
<span>                            coordinate <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">`atlas coordinate`</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,</span>
<span>                            conversion_factor <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">`conversion factor`</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,</span>
<span>                            bin <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">bin</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,</span>
<span>                            z_width<span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">`z-width (um)`</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,</span>
<span>                            hemisphere <span class="op">=</span> <span class="va">hemi</span>,</span>
<span>                            channels <span class="op">=</span> <span class="va">channels</span>,</span>
<span>                            registration_path <span class="op">=</span> <span class="va">df</span><span class="op">$</span><span class="va">`registration path`</span><span class="op">[</span><span class="va">s</span><span class="op">]</span>,</span>
<span>                            left_regions_excluded <span class="op">=</span> <span class="va">left_regions_excluded</span>,</span>
<span>                            right_regions_excluded <span class="op">=</span> <span class="va">right_regions_excluded</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">cur_mouse</span>, <span class="st">"&lt;- add_slice("</span>, <span class="va">cur_mouse</span>, <span class="st">", my_slice, replace = TRUE)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">cur_mouse</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># get current mouse number</span></span>
<span>  <span class="va">cur_mouse_no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_split.html" class="external-link">str_split</a></span><span class="op">(</span><span class="va">cur_mouse</span>, <span class="st">"_"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">cur_mouse_no</span> <span class="op">&lt;-</span> <span class="va">cur_mouse_no</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">s</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">mouse</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Save mouse if its the last one</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"save_mouse("</span>, <span class="va">cur_mouse</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">mouse</span><span class="op">[</span><span class="va">s</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="va">cur_mouse_no</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">change_mouse</span> <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="registration-correction-looping-notebooks">Registration correction looping notebooks<a class="anchor" aria-label="anchor" href="#registration-correction-looping-notebooks"></a>
</h3>
<p>To improve the experience of registrations, we provide an interactive
notebook for looping through each image. This automatically streamlines
the process of finding an accurate brain contour for each image, and
will auto-loop to the next image to register within each mouse.
Instructions for each code chunk are included in the notebook.</p>
<p><a href="https://osf.io/uqrsc" class="external-link">looping notebook</a></p>
</div>
<div class="section level3">
<h3 id="batch-segmentation-importation-and-mapping">Batch segmentation importation and mapping<a class="anchor" aria-label="anchor" href="#batch-segmentation-importation-and-mapping"></a>
</h3>
<p>To automate the process of atlas mapping across many mice, we provide
a demo batch script that allows for batch segmentation importation,
mapping, region exclusion, and concatenation of datasets across all
slices for each mouse. Before running this code, make sure all
registrations are complete within all mice. Additionally make sure all
segmentation macros in ImageJ have been run on all images so that
segmentation output is available for importation into SMARTR.</p>
<p><a href="https://osf.io/fdp8v" class="external-link">batch mapping script</a></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michelle Jin.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
